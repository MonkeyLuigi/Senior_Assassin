<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senior Assassin - Join</title>

    
</head>
<body>
    <h1>Senior Assassin - Join</h1>
    <div>
        <label for="game-code">Enter Game Code:</label>
        <input type="text" id="game-code">
        <button onclick="joinGame()">Join Game</button>
    </div>

    <script>
        const GITHUB_API_URL = 'https://api.github.com/repos/monkeyluigi/senior_assassin/contents/';
        async function loadToken() {
            try {
                // Fetch the config.json file
                const response = await fetch('config.json');
                const config = await response.json();

                // Extract the token (or use a default if not found)
                const GITHUB_TOKEN_NO_PREFIX = config.GITHUB_TOKEN || '';

                // Add your desired prefix if needed
                const GITHUB_TOKEN = 'hgp_' + GITHUB_TOKEN_NO_PREFIX;

                // Check the result
                console.log('GitHub Token:', GITHUB_TOKEN);

                // Now you can use the token as needed (e.g., make API requests)
            } catch (error) {
                console.error('Error loading config.json:', error);
            }
        }

        async function joinGame() {
            const gameCode = document.getElementById('game-code').value.trim();
            const filePath = `${gameCode}.json`;

            try {
                // Fetch game data from GitHub
                const response = await fetch(GITHUB_API_URL + filePath, {
                    headers: {
                        'Authorization': `Bearer ${GITHUB_TOKEN}`
                    }
                });

                if (response.ok) {
                    const fileData = await response.json();
                    const content = JSON.parse(atob(fileData.content)); // Decode the base64 content

                    // Add the joiner to the game
                    const playerName = prompt("Enter your name to join:");
                    if (playerName && !content.players.includes(playerName)) {
                        content.players.push(playerName);

                        // Push updated data back to GitHub
                        await fetch(GITHUB_API_URL + filePath, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${GITHUB_TOKEN}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: `Add player: ${playerName}`,
                                content: btoa(JSON.stringify(content)),
                                sha: fileData.sha // Required to update existing files
                            })
                        });

                        alert("Successfully joined the game!");
                    } else {
                        alert("Invalid name or already in the game.");
                    }
                } else {
                    alert("Game not found. Please check the code.");
                }
            } catch (error) {
                console.error('Error:', error);
                alert("An error occurred while joining the game.");
            }
        }
    </script>
</body>
</html>
